<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pencari Bib Pro — cepat, rapi, profesional</title>
<meta name="color-scheme" content="dark light">
<style>
  /* ========== DESIGN SYSTEM ========== */
  :root {
    /* Dark Theme */
    --bg-primary: #0a0b0f;
    --bg-secondary: #0f1118;
    --bg-tertiary: #161720;
    --surface-primary: #1a1d29;
    --surface-secondary: #232633;
    --surface-hover: #2a2d3a;
    
    --text-primary: #e8eaed;
    --text-secondary: #a8adb8;
    --text-muted: #6b7280;
    --text-inverse: #0f1720;
    
    --accent-primary: #3b82f6;
    --accent-secondary: #06b6d4;
    --accent-hover: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    
    --border-primary: #374151;
    --border-secondary: #4b5563;
    --border-focus: #60a5fa;
    
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-full: 9999px;
    
    --spacing-xs: 4px;
    --spacing-sm: 8px;
    --spacing-md: 16px;
    --spacing-lg: 24px;
    --spacing-xl: 32px;
    --spacing-2xl: 48px;
    
    --font-size-xs: 12px;
    --font-size-sm: 14px;
    --font-size-base: 16px;
    --font-size-lg: 18px;
    --font-size-xl: 20px;
    --font-size-2xl: 24px;
    --font-size-3xl: 30px;
    
    --transition-fast: 150ms ease;
    --transition-normal: 250ms ease;
    --transition-slow: 350ms ease;
  }

  [data-theme="light"] {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f1f5f9;
    --surface-primary: #ffffff;
    --surface-secondary: #f8fafc;
    --surface-hover: #f1f5f9;
    
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-muted: #94a3b8;
    --text-inverse: #ffffff;
    
    --accent-primary: #3b82f6;
    --accent-secondary: #06b6d4;
    --accent-hover: #2563eb;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    
    --border-primary: #e2e8f0;
    --border-secondary: #cbd5e1;
    --border-focus: #60a5fa;
    
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  /* ========== BASE STYLES ========== */
  * {
    box-sizing: border-box;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    margin: 0;
    padding: 0;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    font-size: var(--font-size-base);
    line-height: 1.6;
    min-height: 100vh;
    transition: background-color var(--transition-normal), color var(--transition-normal);
  }

  /* ========== HEADER & NAVIGATION ========== */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(26, 29, 41, 0.95);
    backdrop-filter: blur(12px) saturate(180%);
    border-bottom: 1px solid var(--border-primary);
    transition: all var(--transition-normal);
  }

  [data-theme="light"] .header {
    background: rgba(255, 255, 255, 0.95);
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--spacing-md) var(--spacing-lg);
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-md);
    transition: all var(--transition-normal);
  }

  .brand {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 800;
    font-size: var(--font-size-xl);
    letter-spacing: -0.025em;
    color: var(--text-primary);
    transition: all var(--transition-normal);
  }

  .brand-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    transition: all var(--transition-normal);
  }

  .brand-text .pro {
    color: var(--text-muted);
    font-weight: 400;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  /* ========== COMPACT HEADER STYLES ========== */
  .header.compact .header-top {
    margin-bottom: var(--spacing-sm);
  }

  .header.compact .brand {
    font-size: var(--font-size-lg);
  }

  .header.compact .brand-icon {
    width: 28px;
    height: 28px;
  }

  .header.compact .search-section {
    padding: var(--spacing-sm) 0 0 0;
    margin-bottom: 0;
  }

  .header.compact .search-input {
    height: 44px;
    font-size: var(--font-size-base);
  }

  .header.compact .advanced-panel,
  .header.compact .status-section {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    margin: 0;
    padding: 0;
  }

  /* ========== SEARCH SECTION ========== */
  .search-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-normal);
  }

  .search-container {
    position: relative;
    margin-bottom: var(--spacing-md);
    transition: all var(--transition-normal);
  }

  .header.compact .search-container {
    margin-bottom: 0;
  }

  .search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-icon {
    position: absolute;
    left: var(--spacing-md);
    color: var(--text-muted);
    z-index: 2;
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    height: 56px;
    padding: 0 56px 0 48px;
    background: var(--surface-primary);
    border: 2px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: var(--font-size-lg);
    font-weight: 500;
    outline: none;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-sm);
  }

  .search-input:focus {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), var(--shadow-md);
    transform: translateY(-1px);
  }

  .search-input::placeholder {
    color: var(--text-muted);
    font-weight: 400;
  }

  .clear-button {
    position: absolute;
    right: var(--spacing-sm);
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: var(--surface-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-full);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    opacity: 0;
    visibility: hidden;
  }

  .clear-button.visible {
    opacity: 1;
    visibility: visible;
  }

  .clear-button:hover {
    background: var(--surface-hover);
    color: var(--text-secondary);
    transform: translateY(-50%) scale(1.05);
  }

  /* ========== ADVANCED OPTIONS ========== */
  .advanced-panel {
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    background: var(--surface-primary);
    overflow: hidden;
    transition: all var(--transition-normal);
    margin-bottom: var(--spacing-lg);
  }

  .advanced-summary {
    padding: var(--spacing-md);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all var(--transition-fast);
    user-select: none;
  }

  .advanced-summary:hover {
    background: var(--surface-hover);
    color: var(--text-primary);
  }

  .advanced-icon {
    transition: transform var(--transition-fast);
  }

  .advanced-panel[open] .advanced-icon {
    transform: rotate(180deg);
  }

  .advanced-content {
    padding: 0 var(--spacing-md) var(--spacing-md);
    border-top: 1px solid var(--border-primary);
    background: var(--bg-tertiary);
  }

  .options-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--spacing-lg);
    margin-top: var(--spacing-md);
  }

  .option-group {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .option-group-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--spacing-xs);
  }

  .form-field {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .form-label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-secondary);
  }

  .form-input,
  .form-select {
    height: 44px;
    padding: 0 var(--spacing-md);
    background: var(--surface-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    transition: all var(--transition-fast);
  }

  .form-input:focus,
  .form-select:focus {
    outline: none;
    border-color: var(--border-focus);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  .switch-field {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    background: var(--surface-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .switch-field:hover {
    background: var(--surface-hover);
  }

  .switch-input {
    width: 20px;
    height: 20px;
    accent-color: var(--accent-primary);
  }

  .switch-label {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    flex: 1;
  }

  /* ========== BUTTONS ========== */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
    height: 44px;
    padding: 0 var(--spacing-md);
    background: var(--surface-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-size: var(--font-size-sm);
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    white-space: nowrap;
    user-select: none;
  }

  .btn:hover {
    background: var(--surface-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn.primary {
    background: var(--accent-primary);
    color: var(--text-inverse);
    border-color: var(--accent-primary);
  }

  .btn.primary:hover {
    background: var(--accent-hover);
    border-color: var(--accent-hover);
  }

  .btn.secondary {
    background: var(--accent-secondary);
    color: var(--text-inverse);
    border-color: var(--accent-secondary);
  }

  .btn.ghost {
    background: transparent;
    border-color: transparent;
  }

  .btn.danger {
    background: var(--danger);
    color: var(--text-inverse);
    border-color: var(--danger);
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .btn:disabled:hover {
    transform: none;
    box-shadow: none;
  }

  /* ========== STATUS & PILLS ========== */
  .status-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-lg);
    transition: all var(--transition-normal);
  }

  .status-message {
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    font-style: italic;
  }

  .status-pills {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
  }

  .pill {
    padding: var(--spacing-xs) var(--spacing-sm);
    background: var(--surface-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: 500;
    color: var(--text-secondary);
    white-space: nowrap;
  }

  .pill.primary {
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent-primary);
    border-color: rgba(59, 130, 246, 0.2);
  }

  .pill.success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border-color: rgba(16, 185, 129, 0.2);
  }

  /* ========== MAIN CONTENT ========== */
  .main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg) var(--spacing-2xl);
  }

  .main-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
  }

  .toolbar-section {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .section-title {
    font-size: var(--font-size-xl);
    font-weight: 700;
    color: var(--text-primary);
    margin: var(--spacing-lg) 0 var(--spacing-md);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--border-primary);
  }

  .section-title.empty {
    display: none;
  }

  /* ========== RESULTS GRID ========== */
  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-xl);
  }

  .result-card {
    background: var(--surface-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    cursor: pointer;
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }

  .result-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    opacity: 0;
    transition: opacity var(--transition-fast);
  }

  .result-card:hover {
    background: var(--surface-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--border-secondary);
  }

  .result-card:hover::before {
    opacity: 1;
  }

  .card-header {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
  }

  .card-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
  }

  .card-title {
    font-size: var(--font-size-base);
    font-weight: 600;
    color: var(--text-primary);
    line-height: 1.4;
    margin: 0;
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .card-bibs {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-bottom: var(--spacing-md);
  }

  .bib-chip {
    padding: var(--spacing-xs) var(--spacing-sm);
    background: var(--accent-secondary);
    color: var(--text-inverse);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 600;
    font-family: 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', monospace;
  }

  .bib-chip[data-dist="1"] {
    background: var(--warning);
    color: var(--text-inverse);
  }

  .card-actions {
    display: flex;
    gap: var(--spacing-xs);
    justify-content: flex-end;
  }

  .card-actions .btn {
    height: 36px;
    padding: 0 var(--spacing-sm);
    font-size: var(--font-size-xs);
  }

  /* ========== BROWSE CARDS ========== */
  .browse-card {
    background: var(--surface-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
  }

  .browse-card:hover {
    background: var(--surface-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
  }

  .browse-main {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex: 1;
  }

  .browse-icon {
    width: 24px;
    height: 24px;
    color: var(--text-muted);
  }

  .browse-bib {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-primary);
    font-family: 'SF Mono', Monaco, Inconsolata, 'Roboto Mono', monospace;
  }

  .browse-count {
    padding: var(--spacing-xs) var(--spacing-sm);
    background: var(--surface-secondary);
    color: var(--text-secondary);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-xs);
    font-weight: 500;
  }

  /* ========== EMPTY STATES ========== */
  .empty-state {
    text-align: center;
    padding: var(--spacing-2xl);
    color: var(--text-muted);
  }

  .empty-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto var(--spacing-md);
    opacity: 0.5;
  }

  .empty-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-xs);
  }

  .empty-message {
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    max-width: 400px;
    margin: 0 auto;
  }

  .alert {
    padding: var(--spacing-md);
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: var(--radius-md);
    color: var(--danger);
    font-size: var(--font-size-sm);
    margin: var(--spacing-md) 0;
  }

  /* ========== VIEWER MODAL ========== */
  .viewer-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-normal);
  }

  .viewer-modal.open {
    opacity: 1;
    visibility: visible;
  }

  .viewer-content {
    background: var(--surface-primary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-lg);
    max-width: 95vw;
    max-height: 95vh;
    width: 1200px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: var(--shadow-xl);
  }

  .viewer-header {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border-primary);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-md);
    background: var(--bg-secondary);
  }

  .viewer-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: var(--text-primary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
  }

  .viewer-actions {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
  }

  .viewer-body {
    position: relative;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .viewer-image,
  .viewer-iframe {
    width: 100%;
    height: 80vh;
    max-height: 80vh;
    object-fit: contain;
    border: none;
  }

  .viewer-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--radius-full);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-fast);
    opacity: 0;
  }

  .viewer-nav:hover {
    background: rgba(0, 0, 0, 0.9);
    transform: translateY(-50%) scale(1.1);
  }

  .viewer-nav.prev {
    left: var(--spacing-md);
  }

  .viewer-nav.next {
    right: var(--spacing-md);
  }

  .viewer-nav:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    pointer-events: none;
  }

  .viewer-body:hover .viewer-nav {
    opacity: 1;
  }

  .viewer-footer {
    padding: var(--spacing-md);
    border-top: 1px solid var(--border-primary);
    background: var(--bg-secondary);
    text-align: center;
  }

  .viewer-meta {
    font-size: var(--font-size-sm);
    color: var(--text-muted);
  }

  /* ========== FLOATING ACTION BUTTON ========== */
  .fab {
    position: fixed;
    bottom: var(--spacing-lg);
    right: var(--spacing-lg);
    width: 56px;
    height: 56px;
    background: var(--accent-primary);
    color: var(--text-inverse);
    border: none;
    border-radius: var(--radius-full);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg);
    transition: all var(--transition-fast);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
  }

  .fab.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .fab:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
  }

  /* ========== LOADING STATES ========== */
  .loading {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: var(--text-muted);
    font-size: var(--font-size-sm);
  }

  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--border-primary);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ========== RESPONSIVE DESIGN ========== */
  @media (max-width: 1024px) {
    .results-grid {
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    }
    
    .options-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 768px) {
    .header-content {
      padding: var(--spacing-md);
    }
    
    .header-top {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-md);
    }
    
    .main {
      padding: 0 var(--spacing-md) var(--spacing-xl);
    }
    
    .main-toolbar {
      flex-direction: column;
      align-items: stretch;
    }
    
    .toolbar-section {
      justify-content: center;
    }
    
    .results-grid {
      grid-template-columns: 1fr;
    }
    
    .result-card {
      padding: var(--spacing-md);
    }
    
    .viewer-content {
      margin: var(--spacing-sm);
      max-width: calc(100vw - 16px);
      max-height: calc(100vh - 16px);
    }
    
    .viewer-header {
      flex-direction: column;
      align-items: stretch;
      gap: var(--spacing-sm);
    }
    
    .viewer-actions {
      justify-content: center;
    }
    
    .fab {
      bottom: var(--spacing-md);
      right: var(--spacing-md);
    }
  }

  @media (max-width: 480px) {
    .brand {
      font-size: var(--font-size-lg);
    }
    
    .search-input {
      height: 48px;
      font-size: var(--font-size-base);
    }
    
    .card-header {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .card-actions {
      width: 100%;
      justify-content: space-between;
    }
  }

  /* ========== ACCESSIBILITY ========== */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* ========== FOCUS STYLES ========== */
  .btn:focus-visible,
  .result-card:focus-visible,
  .browse-card:focus-visible {
    outline: 2px solid var(--accent-primary);
    outline-offset: 2px;
  }

  /* ========== PRINT STYLES ========== */
  @media print {
    .header,
    .fab,
    .viewer-modal {
      display: none;
    }
    
    .main {
      max-width: none;
    }
    
    .result-card {
      break-inside: avoid;
      box-shadow: none;
      border: 1px solid #ccc;
    }
  }
</style>
</head>
<body>
  <!-- Header -->
  <header class="header" role="banner">
    <div class="header-content">
      <div class="header-top">
        <div class="brand" aria-label="Pencari Bib Pro">
          <div class="brand-icon" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM5 9.5C5 7.01 7.01 5 9.5 5S14 7.01 14 9.5 11.99 14 9.5 14 5 11.99 5 9.5z"/>
            </svg>
          </div>
          <span class="brand-text">
            Pencari Bib <span class="pro">Pro</span>
          </span>
        </div>
        
        <div class="header-actions">
          <button id="themeToggle" class="btn ghost" title="Ganti tema gelap/terang" aria-label="Ganti tema">
            🌙
          </button>
        </div>
      </div>

      <!-- Search Section -->
      <div class="search-section" role="search">
        <div class="search-container">
          <div class="search-input-wrapper">
            <div class="search-icon" aria-hidden="true">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM5 9.5C5 7.01 7.01 5 9.5 5S14 7.01 14 9.5 11.99 14 9.5 14 5 11.99 5 9.5z"/>
              </svg>
            </div>
            <input 
              id="bibInput" 
              type="text" 
              inputmode="numeric" 
              autocomplete="off" 
              placeholder="Masukkan nomor bib... (contoh: 13405)" 
              aria-label="Cari nomor bib" 
              class="search-input"
            />
            <button id="clearInput" class="clear-button" title="Bersihkan input" aria-label="Bersihkan">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Advanced Options -->
        <details id="advPanel" class="advanced-panel">
          <summary class="advanced-summary">
            <span>⚙️ Opsi Lanjutan</span>
            <div class="advanced-icon" aria-hidden="true">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M7.41 8.84L12 13.42l4.59-4.58L18 10.25l-6 6-6-6z"/>
              </svg>
            </div>
          </summary>
          <div class="advanced-content">
            <div class="options-grid">
              <div class="option-group">
                <div class="option-group-title">Pengaturan Pencarian</div>
                <div class="form-field">
                  <label for="minDigits" class="form-label">Minimal digit untuk pencarian</label>
                  <input id="minDigits" type="number" min="1" step="1" value="2" class="form-input" />
                </div>
                <div class="form-field">
                  <label for="sortMode" class="form-label">Urutkan hasil</label>
                  <select id="sortMode" class="form-select">
                    <option value="best">Terbaik (jarak → kepercayaan → nama)</option>
                    <option value="conf">Kepercayaan tertinggi</option>
                    <option value="name">Nama file (A→Z)</option>
                  </select>
                </div>
              </div>
              
              <div class="option-group">
                <div class="option-group-title">Aturan Pencocokan</div>
                <label class="switch-field" title="Anggap 04 dan 4 setara saat pencocokan">
                  <input id="ignoreZeros" type="checkbox" checked class="switch-input" />
                  <span class="switch-label">Abaikan nol di depan</span>
                </label>
                <label class="switch-field" title="Wajibkan panjang bib kandidat sama dengan input">
                  <input id="sameLen" type="checkbox" class="switch-input" />
                  <span class="switch-label">Wajibkan panjang sama</span>
                </label>
                <label class="switch-field" title="Hanya tampilkan kecocokan tepat (jarak 0)">
                  <input id="exactOnly" type="checkbox" class="switch-input" />
                  <span class="switch-label">Hanya cocok tepat</span>
                </label>
              </div>
            </div>
          </div>
        </details>

        <!-- Status & Pills -->
        <div class="status-section">
          <div id="status" class="status-message" aria-live="polite">Memuat dataset...</div>
          <div class="status-pills">
            <div class="pill primary" id="countPill">0 hasil</div>
            <div class="pill" id="datasetPill">dataset: belum dimuat</div>
            <div class="pill" id="cachePill">cache: —</div>
            <div class="pill" id="rulePill">aturan: mengandung input</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <!-- Toolbar -->
    <div class="main-toolbar">
      <div class="toolbar-section">
        <label class="btn" title="Muat dataset dari berkas JSON (akan disimpan ke cache)">
          <input id="filePicker" type="file" accept=".json,application/json" hidden />
          📁 Pilih JSON
        </label>
        <button id="browseBtn" class="btn">📋 Browse Semua Bib</button>
        <button id="clearCache" class="btn" title="Hapus dataset yang tersimpan di browser ini">🗑️ Hapus Cache</button>
      </div>
      <div id="results-toolbar" class="toolbar-section" hidden>
        <button id="exportCsv" class="btn secondary" title="Ekspor hasil ke CSV">📊 Ekspor CSV</button>
      </div>
    </div>

    <!-- Results Section -->
    <h2 id="results-title" class="section-title"></h2>
    
    <!-- Empty States -->
    <div id="noData" class="empty-state">
      <div class="empty-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
        </svg>
      </div>
      <div class="empty-title">Belum ada dataset yang dimuat</div>
      <div class="empty-message">Pilih berkas JSON untuk memuat dataset pencarian nomor bib</div>
    </div>
    
    <div id="noMatches" class="empty-state" hidden>
      <div class="empty-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.5 21.5 20l-6-6zM5 9.5C5 7.01 7.01 5 9.5 5S14 7.01 14 9.5 11.99 14 9.5 14 5 11.99 5 9.5z"/>
        </svg>
      </div>
      <div class="empty-title">Tidak ada hasil ditemukan</div>
      <div class="empty-message">Coba gunakan kata kunci yang berbeda atau ubah pengaturan pencarian</div>
    </div>

    <!-- Results Grid -->
    <div id="grid" class="results-grid" aria-live="polite"></div>
    
    <!-- Loading Sentinel -->
    <div id="sentinel" style="height: 1px;" aria-hidden="true"></div>
  </main>

  <!-- Viewer Modal -->
  <div id="viewer" class="viewer-modal" aria-label="Pratinjau gambar ukuran penuh" role="dialog" aria-modal="true">
    <div class="viewer-content">
      <div class="viewer-header">
        <h3 id="viewerTitle" class="viewer-title">(judul)</h3>
        <div class="viewer-actions">
          <a id="viewerOpenDrive" class="btn" target="_blank" rel="noopener noreferrer">🔗 Buka di Drive</a>
          <a id="viewerDownload" class="btn primary" target="_blank" rel="noopener noreferrer">⬇️ Unduh</a>
          <button id="viewerClose" class="btn danger">✕ Tutup</button>
        </div>
      </div>
      <div class="viewer-body">
        <img id="viewerImg" alt="pratinjau gambar" class="viewer-image" />
        <iframe id="viewerIframe" class="viewer-iframe" allow="autoplay; fullscreen" hidden></iframe>
        <button id="prevBtn" class="viewer-nav prev" title="Sebelumnya (Panah Kiri)" aria-label="Gambar sebelumnya">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
          </svg>
        </button>
        <button id="nextBtn" class="viewer-nav next" title="Berikutnya (Panah Kanan)" aria-label="Gambar berikutnya">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
          </svg>
        </button>
      </div>
      <div class="viewer-footer">
        <div id="viewerMeta" class="viewer-meta"></div>
      </div>
    </div>
  </div>

  <!-- Floating Action Button -->
  <button id="toTop" class="fab" title="Kembali ke atas" aria-label="Kembali ke atas">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
      <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
  </button>

<script>
/* ===========================================================
    Pencari Bib Pro — Clean scrolling header implementation
    =========================================================== */
(() => {
  // --- Elemen UI ---
  const bibInput = document.getElementById('bibInput');
  const clearInput = document.getElementById('clearInput');
  const minDigits = document.getElementById('minDigits');
  const ignoreZeros = document.getElementById('ignoreZeros');
  const sameLen = document.getElementById('sameLen');
  const exactOnly = document.getElementById('exactOnly');
  const sortMode = document.getElementById('sortMode');
  const filePicker = document.getElementById('filePicker');
  const browseBtn = document.getElementById('browseBtn');
  const exportCsv = document.getElementById('exportCsv');
  const clearCache = document.getElementById('clearCache');
  const themeToggle = document.getElementById('themeToggle');
  const grid = document.getElementById('grid');
  const sentinel = document.getElementById('sentinel');
  const statusEl = document.getElementById('status');
  const countPill = document.getElementById('countPill');
  const datasetPill = document.getElementById('datasetPill');
  const cachePill = document.getElementById('cachePill');
  const rulePill = document.getElementById('rulePill');
  const noDataEl = document.getElementById('noData');
  const noMatchesEl = document.getElementById('noMatches');
  const toTop = document.getElementById('toTop');
  const resultsToolbar = document.getElementById('results-toolbar');
  const resultsTitle = document.getElementById('results-title');
  const header = document.querySelector('.header');
  
  // Dialog Viewer
  const viewerModal = document.getElementById('viewer');
  const viewerBody = document.querySelector('.viewer-body');
  const viewerTitle = document.getElementById('viewerTitle');
  const viewerImg = document.getElementById('viewerImg');
  const viewerIframe = document.getElementById('viewerIframe');
  const viewerMeta = document.getElementById('viewerMeta');
  const viewerOpenDrv = document.getElementById('viewerOpenDrive');
  const viewerDownload = document.getElementById('viewerDownload');
  const viewerClose = document.getElementById('viewerClose');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');

  // --- State & Penyimpanan ---
  const DB_NAME = 'bib-finder-cache';
  const DB_STORE = 'datasets';
  const DB_KEY = 'active';
  let idb = null;

  const PREF_KEY = 'bibFinderPrefs';
  const prefs = loadPrefs();
  applyPrefs();

  function loadPrefs() {
    try { const raw = localStorage.getItem(PREF_KEY); return raw ? JSON.parse(raw) : {}; }
    catch { return {}; }
  }

  function savePrefs() {
    try {
      const p = {
        theme: document.documentElement.getAttribute('data-theme') || 'dark',
        minDigits: parseInt(minDigits.value || '2', 10),
        ignoreZeros: ignoreZeros.checked,
        sameLen: sameLen.checked,
        exactOnly: exactOnly.checked,
        sortMode: sortMode.value
      };
      localStorage.setItem(PREF_KEY, JSON.stringify(p));
    } catch {}
  }

  function applyPrefs() {
    if (prefs.theme) document.documentElement.setAttribute('data-theme', prefs.theme);
    if (typeof prefs.minDigits === 'number') minDigits.value = prefs.minDigits;
    if (typeof prefs.ignoreZeros === 'boolean') ignoreZeros.checked = prefs.ignoreZeros;
    if (typeof prefs.sameLen === 'boolean') sameLen.checked = prefs.sameLen;
    if (typeof prefs.exactOnly === 'boolean') exactOnly.checked = prefs.exactOnly;
    if (typeof prefs.sortMode === 'string') sortMode.value = prefs.sortMode;
    updateThemeToggle();
  }

  function updateThemeToggle() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    themeToggle.textContent = isDark ? '☀️' : '🌙';
  }

  // Cache functions
  async function idbOpen() {
    return new Promise((resolve) => {
      if (!('indexedDB' in window)) return resolve(null);
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE, { keyPath: 'key' });
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => resolve(null);
    });
  }

  async function cachePut(payload) {
    const entry = { key: DB_KEY, ts: Date.now(), ...payload };
    if (idb) {
      try {
        await new Promise((resolve, reject) => {
          const tx = idb.transaction(DB_STORE, 'readwrite');
          tx.oncomplete = resolve; tx.onerror = () => reject(tx.error);
          tx.objectStore(DB_STORE).put(entry);
        });
        cachePill.textContent = `cache: disimpan (${new Date(entry.ts).toLocaleString()})`;
        return true;
      } catch {}
    }
    try {
      localStorage.setItem('bibFinderCache', JSON.stringify(entry));
      cachePill.textContent = `cache: disimpan (localStorage)`; return true;
    } catch {
      cachePill.textContent = `cache: gagal menyimpan`; return false;
    }
  }

  async function cacheGet() {
    if (idb) {
      try {
        const result = await new Promise((resolve) => {
          const tx = idb.transaction(DB_STORE, 'readonly');
          tx.onerror = () => resolve(null);
          const req = tx.objectStore(DB_STORE).get(DB_KEY);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => resolve(null);
        });
        if (result) return result;
      } catch {}
    }
    try { const raw = localStorage.getItem('bibFinderCache'); return raw ? JSON.parse(raw) : null; }
    catch { return null; }
  }

  async function cacheClear() {
    let ok = false;
    if (idb) {
      try {
        await new Promise((resolve) => {
          const tx = idb.transaction(DB_STORE, 'readwrite');
          tx.oncomplete = resolve; tx.onerror = () => resolve();
          tx.objectStore(DB_STORE).delete(DB_KEY);
        });
        ok = true;
      } catch {}
    }
    try { localStorage.removeItem('bibFinderCache'); ok = true; } catch {}
    cachePill.textContent = ok ? 'cache: dihapus' : 'cache: gagal dihapus';
  }

  let DATA = [];
  let BROWSE_INDEX = new Map();
  let LAST_RESULTS = [];
  let LAST_QUERY_DIGITS = '';
  let CURRENT_INDEX = -1;
  const RENDER_BATCH = 50;
  let renderedCount = 0;
  let touchStartX = 0, touchEndX = 0;
  const SWIPE_THRESHOLD = 50;

  // Header scroll behavior - simplified and more aggressive
  let lastScrollY = 0;
  let isCompact = false;
  let scrollTimeout = null;
  
  // More aggressive thresholds to prevent oscillation
  const COMPACT_THRESHOLD = 300;   // Scroll down to compact
  const EXPAND_THRESHOLD = 50;     // Must scroll very close to top to expand
  const UPDATE_DELAY = 100;        // Delay all updates to prevent rapid changes

  function updateHeaderState() {
    const currentScrollY = window.scrollY;
    
    // Simple state logic with large hysteresis gap
    let shouldBeCompact;
    
    if (currentScrollY > COMPACT_THRESHOLD) {
      shouldBeCompact = true;
    } else if (currentScrollY < EXPAND_THRESHOLD) {
      shouldBeCompact = false;
    } else {
      // In the middle zone - maintain current state
      shouldBeCompact = isCompact;
    }
    
    // Only change state if different and apply immediately
    if (shouldBeCompact !== isCompact) {
      isCompact = shouldBeCompact;
      header.classList.toggle('compact', isCompact);
    }
    
    // Back to top button
    toTop.classList.toggle('visible', currentScrollY > 600);
  }

  function handleScroll() {
    // Clear any pending updates
    clearTimeout(scrollTimeout);
    
    // Debounce the update to prevent rapid changes
    scrollTimeout = setTimeout(() => {
      updateHeaderState();
      lastScrollY = window.scrollY;
    }, UPDATE_DELAY);
  }

  // Show/hide clear button based on input
  function updateClearButton() {
    if (bibInput.value.trim()) {
      clearInput.classList.add('visible');
    } else {
      clearInput.classList.remove('visible');
    }
  }

  (async function boot() {
    idb = await idbOpen();
    cachePill.textContent = idb ? 'cache: siap' : 'cache: cadangan localStorage';
    try {
      setStatus('Mengambil ./bib_export.json…', false, true);
      const res = await fetch('./bib_export.json', { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      ingest(json, 'bib_export.json');
      await cachePut({ label: 'bib_export.json', data: json });
      setStatus('Berhasil dimuat dari file dan disimpan ke cache. Ketik untuk mencari.');
    } catch (e) {
      setStatus('Gagal mengambil file; mencoba dataset yang tersimpan…');
      const cached = await cacheGet();
      if (cached?.data && Array.isArray(cached.data)) {
        ingest(cached.data, cached.label || 'cache');
        setStatus('Dimuat dari cache. Ketik untuk mencari.');
      } else {
        setStatus('Tidak ada dataset. Pilih berkas JSON untuk memuat.');
        noDataEl.hidden = false;
      }
    }
  })();

  function ingest(json, label = 'dataset') {
    if (!Array.isArray(json)) { setStatus('Root JSON harus berupa array objek.', true); return; }
    DATA = json.map(item => ({
      file_id: item.file_id ?? null, 
      file_name: item.file_name ?? '', 
      web_view_link: item.web_view_link ?? null,
      bib_numbers: Array.isArray(item.bib_numbers) ? item.bib_numbers.filter(x => typeof x === 'string' || typeof x === 'number').map(String) : [],
      confidences: Array.isArray(item.confidences) ? item.confidences : []
    }));
    datasetPill.textContent = `dataset: ${label} (${DATA.length} foto)`;
    noDataEl.hidden = true;
    
    setStatus('Mengindeks data untuk browse...', false, true);
    BROWSE_INDEX.clear();
    for (const rec of DATA) {
      const seenInThisRecord = new Set();
      for (const bib of rec.bib_numbers) {
        const cleanBib = digitsOnly(bib);
        if (cleanBib && !seenInThisRecord.has(cleanBib)) {
          BROWSE_INDEX.set(cleanBib, (BROWSE_INDEX.get(cleanBib) || 0) + 1);
          seenInThisRecord.add(cleanBib);
        }
      }
    }
    setStatus('');
    refresh();
  }

  const digitsOnly = s => (s ?? '').toString().replace(/\D+/g, '');
  const stripLeadingZeros = s => {
    const raw = digitsOnly(s);
    if (raw === '') return '';
    const t = raw.replace(/^0+/, '');
    return t === '' ? '0' : t;
  };

  function isWithinOneEdit(a, b) {
    if (a === b) return { ok: true, dist: 0 };
    const la = a.length, lb = b.length;
    if (Math.abs(la - lb) > 1) return { ok: false, dist: 2 };
    if (la === lb) {
      let mismatches = 0;
      for (let i = 0; i < la; i++) { if (a[i] !== b[i] && ++mismatches > 1) return { ok: false, dist: 2 }; }
      return { ok: true, dist: 1 };
    }
    let i = 0, j = 0, skips = 0;
    const long = la > lb ? a : b, short = la > lb ? b : a;
    while (i < long.length && j < short.length) {
      if (long[i] === short[j]) { i++; j++; } 
      else { if (++skips > 1) return { ok: false, dist: 2 }; i++; }
    }
    const dist = skips + ((long.length - i) > 0 ? 1 : 0);
    return { ok: dist <= 1, dist };
  }

  function bestDistance(user, cand, ignoreZerosFlag) {
    const a1 = digitsOnly(user), b1 = digitsOnly(cand);
    const a2 = stripLeadingZeros(user), b2 = stripLeadingZeros(cand);
    let best = { ok: false, dist: 2 };
    const tryPair = (x, y) => { const r = isWithinOneEdit(x, y); if (r.dist < best.dist) best = r; };
    tryPair(a1, b1);
    if (ignoreZerosFlag) tryPair(a2, b2);
    return best;
  }

  const driveDirectImg = (fileId) => fileId ? `https://drive.google.com/uc?export=view&id=${encodeURIComponent(fileId)}` : null;
  const drivePreviewUrl = (fileId, webViewLink) => {
    if (fileId) return `https://drive.google.com/file/d/${encodeURIComponent(fileId)}/preview`;
    if (webViewLink) {
      const m = webViewLink.match(/\/d\/([^/]+)/);
      if (m) return `https://drive.google.com/file/d/${encodeURIComponent(m[1])}/preview`;
    }
    return null;
  };

  function refresh() {
    const raw = digitsOnly(bibInput.value);
    const minLen = Math.max(1, parseInt(minDigits.value || '1', 10));
    const requireSameLen = sameLen.checked;
    const requireExact = exactOnly.checked;

    grid.innerHTML = '';
    noMatchesEl.hidden = true;
    resultsTitle.textContent = '';
    renderedCount = 0;
    LAST_RESULTS = [];
    LAST_QUERY_DIGITS = raw || '';
    resultsToolbar.hidden = true;

    // Update rule pill
    if (!requireSameLen && !requireExact) {
        rulePill.textContent = 'aturan: mengandung input';
    } else if (requireExact) {
        rulePill.textContent = 'aturan: cocok tepat';
    } else {
        rulePill.textContent = 'aturan: ≤1 edit';
    }

    if (DATA.length === 0) {
      noDataEl.hidden = false;
      countPill.textContent = '0 hasil';
      return;
    }
    noDataEl.hidden = true;

    if (!raw || raw.length < minLen) {
      countPill.textContent = '0 hasil';
      setStatus(`Masukkan minimal ${minLen} digit untuk mencari.`);
      return;
    }

    resultsTitle.textContent = `Hasil Pencarian untuk "${raw}"`;
    resultsTitle.classList.remove('empty');
    const results = [];

    for (const rec of DATA) {
      if (!rec || !Array.isArray(rec.bib_numbers) || rec.bib_numbers.length === 0) continue;
      
      const matches = [];
      for (let idx = 0; idx < rec.bib_numbers.length; idx++) {
        const candidate = String(rec.bib_numbers[idx] ?? '');
        const candDigits = digitsOnly(candidate);
        if (!candDigits) continue;

        if (!requireSameLen && !requireExact) {
            if (candDigits.includes(raw)) {
                const conf = Array.isArray(rec.confidences) ? rec.confidences[idx] ?? null : null;
                const pseudoDist = (candDigits === raw) ? 0 : 1;
                matches.push({ bib: candidate, dist: pseudoDist, conf });
            }
        } else {
            if (requireSameLen && candDigits.length !== raw.length) continue;
            const d = bestDistance(raw, candDigits, ignoreZeros.checked);
            if (requireExact ? (d.ok && d.dist === 0) : (d.ok && d.dist <= 1)) {
                const conf = Array.isArray(rec.confidences) ? rec.confidences[idx] ?? null : null;
                matches.push({ bib: candidate, dist: d.dist, conf });
            }
        }
      }

      if (matches.length) {
        matches.sort((a, b) => (a.dist - b.dist) || ((b.conf ?? -1) - (a.conf ?? -1)));
        results.push({ rec, matches, bestDist: matches[0].dist, bestConf: matches[0].conf ?? -1 });
      }
    }

    if (sortMode.value === 'conf') {
      results.sort((A, B) => (B.bestConf - A.bestConf) || (A.bestDist - B.bestDist) || String(A.rec.file_name).localeCompare(String(B.rec.file_name)));
    } else if (sortMode.value === 'name') {
      results.sort((A, B) => String(A.rec.file_name).localeCompare(String(B.rec.file_name)) || (A.bestDist - B.bestDist) || (B.bestConf - A.bestConf));
    } else {
      results.sort((A, B) => (A.bestDist - B.bestDist) || (B.bestConf - A.bestConf) || String(A.rec.file_name).localeCompare(String(B.rec.file_name)));
    }

    LAST_RESULTS = results;
    countPill.textContent = `${results.length} hasil`;
    if (results.length === 0) {
      noMatchesEl.hidden = false;
      return;
    }
    resultsToolbar.hidden = false;
    renderMore(buildCard);
    setupObserver(buildCard);
  }
  
  function buildCard(item, idx) {
    const { rec, matches } = item;
    const card = document.createElement('article');
    card.className = 'result-card';
    card.tabIndex = 0;
    card.setAttribute('role', 'button');
    card.setAttribute('aria-label', `Lihat foto ${rec.file_name || 'tanpa nama'}`);
    
    card.addEventListener('click', (e) => {
      if (e.target.closest('a')) { return; }
      openPreview(idx);
    });
    
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openPreview(idx);
      }
    });
    
    // Card Header
    const header = document.createElement('div');
    header.className = 'card-header';
    
    const icon = document.createElement('div');
    icon.className = 'card-icon';
    icon.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
      <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
    </svg>`;
    
    const title = document.createElement('h3');
    title.className = 'card-title';
    title.textContent = rec.file_name || '(tanpa nama berkas)';
    
    header.appendChild(icon);
    header.appendChild(title);
    
    // Card Bibs
    const bibsContainer = document.createElement('div');
    bibsContainer.className = 'card-bibs';
    matches.slice(0, 6).forEach(m => {
      const chip = document.createElement('span');
      chip.className = 'bib-chip';
      chip.dataset.dist = String(m.dist);
      chip.title = (m.conf != null) ? `Jarak: ${m.dist} | Kepercayaan: ${m.conf}` : `Jarak: ${m.dist}`;
      chip.textContent = m.bib;
      bibsContainer.appendChild(chip);
    });
    
    // Card Actions
    const actions = document.createElement('div');
    actions.className = 'card-actions';

    if (rec.web_view_link) {
      const driveLink = document.createElement('a');
      driveLink.href = rec.web_view_link;
      driveLink.target = '_blank';
      driveLink.rel = 'noopener noreferrer';
      driveLink.textContent = 'Drive';
      driveLink.className = 'btn';
      driveLink.title = 'Buka di Google Drive';
      actions.appendChild(driveLink);
    }
    
    card.appendChild(header);
    card.appendChild(bibsContainer);
    card.appendChild(actions);
    return card;
  }

  function browseAll() {
    if (DATA.length === 0) {
      setStatus('Muat dataset terlebih dahulu untuk browse.', true, true);
      return;
    }
    grid.innerHTML = '';
    bibInput.value = '';
    updateClearButton();
    noMatchesEl.hidden = true;
    resultsToolbar.hidden = true;
    renderedCount = 0;
    const minLen = Math.max(1, parseInt(minDigits.value || '1', 10));

    setStatus('Memfilter indeks...', false, true);
    setTimeout(() => {
        const filteredBibs = [];
        for (const [bib, count] of BROWSE_INDEX.entries()) {
            if (bib.length >= minLen) {
                filteredBibs.push({ bib, count });
            }
        }
        
        LAST_RESULTS = filteredBibs.sort((a, b) => a.bib - b.bib);
        
        countPill.textContent = `${LAST_RESULTS.length} bib terindeks`;
        resultsTitle.textContent = 'Indeks Semua Nomor Bib';
        resultsTitle.classList.remove('empty');
        setStatus('');
        
        if (LAST_RESULTS.length === 0) {
            noMatchesEl.querySelector('.empty-title').textContent = `Tidak ada bib dengan minimal ${minLen} digit`;
            noMatchesEl.hidden = false;
            return;
        }

        renderMore(buildBrowseCard);
        setupObserver(buildBrowseCard);
    }, 10);
  }

  function buildBrowseCard(item, idx) {
    const { bib, count } = item;
    const card = document.createElement('article');
    card.className = 'browse-card';
    card.tabIndex = 0;
    card.setAttribute('role', 'button');
    card.setAttribute('aria-label', `Cari bib ${bib}`);
    
    const main = document.createElement('div');
    main.className = 'browse-main';
    
    const icon = document.createElement('div');
    icon.className = 'browse-icon';
    icon.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/>
    </svg>`;
    
    const bibSpan = document.createElement('span');
    bibSpan.className = 'browse-bib';
    bibSpan.textContent = bib;
    
    main.appendChild(icon);
    main.appendChild(bibSpan);

    const countChip = document.createElement('span');
    countChip.className = 'browse-count';
    countChip.textContent = `${count} foto`;
    countChip.title = `Nomor bib ${bib} ditemukan di ${count} foto`;
    
    card.appendChild(main);
    card.appendChild(countChip);

    card.addEventListener('click', () => {
        bibInput.value = bib;
        updateClearButton();
        refresh();
    });
    
    card.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        bibInput.value = bib;
        updateClearButton();
        refresh();
      }
    });
    
    return card;
  }
  
  function renderMore(builderFn) {
    const frag = document.createDocumentFragment();
    const end = Math.min(renderedCount + RENDER_BATCH, LAST_RESULTS.length);
    for (let i = renderedCount; i < end; i++) {
      frag.appendChild(builderFn(LAST_RESULTS[i], i));
    }
    grid.appendChild(frag);
    renderedCount = end;
  }

  let observer = null;
  function setupObserver(builderFn) {
    observer?.disconnect?.();
    observer = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting && renderedCount < LAST_RESULTS.length) {
          renderMore(builderFn);
        }
      });
    });
    observer.observe(sentinel);
  }

  function openPreview(idx) {
    if (!LAST_RESULTS.length || typeof LAST_RESULTS[idx] !== 'object') return;
    CURRENT_INDEX = Math.min(Math.max(idx, 0), LAST_RESULTS.length - 1);
    updateViewer();
    viewerModal.classList.add('open');
    document.body.style.overflow = 'hidden';
    document.addEventListener('keydown', onViewerKey);
    viewerBody.addEventListener('touchstart', handleTouchStart, { passive: true });
    viewerBody.addEventListener('touchmove', handleTouchMove, { passive: true });
    viewerBody.addEventListener('touchend', handleTouchEnd);
  }

  function closePreview() {
    viewerImg.src = '';
    viewerIframe.src = '';
    viewerModal.classList.remove('open');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', onViewerKey);
    viewerBody.removeEventListener('touchstart', handleTouchStart);
    viewerBody.removeEventListener('touchmove', handleTouchMove);
    viewerBody.removeEventListener('touchend', handleTouchEnd);
  }

  function handleTouchStart(e) { touchStartX = e.changedTouches[0].screenX; }
  function handleTouchMove(e) { touchEndX = e.changedTouches[0].screenX; }
  function handleTouchEnd() {
    const deltaX = touchEndX - touchStartX;
    if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
        if (deltaX < 0) movePreview(1);
        else movePreview(-1);
    }
    touchStartX = 0;
    touchEndX = 0;
  }

  function onViewerKey(e) {
    if (e.key === 'Escape') { e.preventDefault(); closePreview(); }
    if (e.key === 'ArrowLeft') { e.preventDefault(); movePreview(-1); }
    if (e.key === 'ArrowRight') { e.preventDefault(); movePreview(1); }
  }

  function movePreview(delta) {
    const next = CURRENT_INDEX + delta;
    if (next < 0 || next >= LAST_RESULTS.length) return;
    CURRENT_INDEX = next;
    updateViewer();
  }

  function updateViewer() {
    const item = LAST_RESULTS[CURRENT_INDEX];
    if (!item) return;
    const { rec, matches } = item;
    const imgUrl = driveDirectImg(rec.file_id);
    const prevUrl = drivePreviewUrl(rec.file_id, rec.web_view_link);
    
    viewerTitle.textContent = rec.file_name || '(tanpa nama berkas)';
    const topBibs = matches.slice(0, 5).map(m => `${m.bib}${m.dist === 0 ? ' (cocok)' : ''}`).join(', ');
    viewerMeta.textContent = topBibs ? `Kecocokan: ${topBibs}` : '';

    if (rec.web_view_link) { 
      viewerOpenDrv.style.display = 'inline-flex'; 
      viewerOpenDrv.href = rec.web_view_link; 
    } else { 
      viewerOpenDrv.style.display = 'none'; 
      viewerOpenDrv.removeAttribute('href'); 
    }

    if (imgUrl) { 
      viewerDownload.style.display = 'inline-flex'; 
      viewerDownload.href = imgUrl; 
    } else { 
      viewerDownload.style.display = 'none'; 
      viewerDownload.removeAttribute('href'); 
    }

    if (prevUrl) {
        viewerIframe.hidden = false; 
        viewerImg.hidden = true;
        viewerIframe.src = prevUrl;
    } else if (imgUrl) {
        viewerImg.hidden = false; 
        viewerIframe.hidden = true;
        viewerImg.src = imgUrl;
    } else {
        viewerImg.hidden = false; 
        viewerIframe.hidden = true;
        viewerImg.src = ''; 
        viewerImg.alt = 'Pratinjau tidak tersedia';
    }
    
    prevBtn.disabled = CURRENT_INDEX <= 0;
    nextBtn.disabled = CURRENT_INDEX >= (LAST_RESULTS.length - 1);
  }

  // Event Listeners
  viewerClose.addEventListener('click', closePreview);
  viewerModal.addEventListener('click', (e) => {
    if (e.target === viewerModal) closePreview();
  });
  prevBtn.addEventListener('click', () => movePreview(-1));
  nextBtn.addEventListener('click', () => movePreview(1));

  let debounceTimer = null;
  const trigger = () => { 
    clearTimeout(debounceTimer); 
    debounceTimer = setTimeout(() => { 
      savePrefs(); 
      refresh(); 
    }, 150); 
  };

  bibInput.addEventListener('input', () => {
    updateClearButton();
    trigger();
  });
  
  bibInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      trigger();
    }
  });

  minDigits.addEventListener('input', trigger);
  ignoreZeros.addEventListener('change', trigger);
  sameLen.addEventListener('change', trigger);
  exactOnly.addEventListener('change', trigger);
  sortMode.addEventListener('change', trigger);
  
  clearInput.addEventListener('click', () => { 
    bibInput.value = ''; 
    updateClearButton();
    trigger(); 
    bibInput.focus(); 
  });

  filePicker.addEventListener('change', async (ev) => {
    const file = ev.target.files?.[0]; 
    if (!file) return;
    try {
      setStatus(`Membaca ${file.name}…`, false, true);
      const text = await file.text();
      const json = JSON.parse(text);
      ingest(json, file.name);
      await cachePut({ label: file.name, data: json });
      setStatus(`Berhasil memuat ${file.name} dan menyimpannya ke cache. Ketik untuk mencari.`);
    } catch (e) {
      setStatus(`Gagal membaca berkas JSON: ${e.message}`, true, true);
    } finally {
      ev.target.value = '';
    }
  });

  browseBtn.addEventListener('click', browseAll);
  clearCache.addEventListener('click', async () => { await cacheClear(); });
  
  themeToggle.addEventListener('click', () => {
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', next);
    updateThemeToggle();
    savePrefs();
  });

  // Scroll handling with throttling for better performance
  let scrollThrottleTimer = null;
  window.addEventListener('scroll', () => {
    if (scrollThrottleTimer) return;
    
    scrollThrottleTimer = setTimeout(() => {
      handleScroll();
      scrollThrottleTimer = null;
    }, 16); // ~60fps
  }, { passive: true });
  
  toTop.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Export CSV functionality
  exportCsv.addEventListener('click', () => {
    if (LAST_RESULTS.length === 0) return;
    
    const csvContent = [
      ['Nama File', 'File ID', 'Link', 'Nomor Bib', 'Jarak', 'Kepercayaan'].join(','),
      ...LAST_RESULTS.flatMap(item => 
        item.matches.map(match => [
          `"${item.rec.file_name || ''}"`,
          `"${item.rec.file_id || ''}"`,
          `"${item.rec.web_view_link || ''}"`,
          `"${match.bib}"`,
          match.dist,
          match.conf ?? ''
        ].join(','))
      )
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `pencarian-bib-${LAST_QUERY_DIGITS}-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
  });

  let statusTimer = null;
  function setStatus(msg, isError = false, transient = false) {
    if (msg.includes('…') || msg.includes('...')) {
      statusEl.innerHTML = `<span class="loading"><span class="spinner"></span> ${msg}</span>`;
    } else {
      statusEl.textContent = msg;
    }
    statusEl.style.color = isError ? 'var(--danger)' : 'var(--text-muted)';
    if (transient) {
      clearTimeout(statusTimer);
      statusTimer = setTimeout(() => { 
        statusEl.textContent = ''; 
        statusEl.innerHTML = '';
      }, 2000);
    }
  }

  // Initialize clear button state
  updateClearButton();
})();
</script>
</body>
</html>